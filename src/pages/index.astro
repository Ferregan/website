---
import { getCollection } from "astro:content";

import PortfolioSection from "../components/PortfolioSection.astro";
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";

const portfolioItems = await getCollection("portfolio");
const portfolio = portfolioItems.sort((a, b) => a.data.order - b.data.order);
---

<BaseLayout>
  <nav class="hidden md:flex flex-col pr-20 w-64 ml-16">
    <ul class="sticky top-5 flex flex-col">
      {
        portfolio.map((item) => (
          <li>
            <a class="hover:font-bold" href={`#${item.slug}`}>
              {item.data.title}
            </a>
          </li>
        ))
      }
    </ul>
  </nav>
  <main class="flex flex-1 flex-col max-w-3xl pl-3 md:pl-0 md:mr-6">
    <Header />
    {portfolio.map((item) => <PortfolioSection item={item} />)}
  </main>
  <footer class="ml-auto md:mr-3">
    <nav class="sticky right-0 inset-y-0 w-6">
      <div
        class="origin-top-left translate-y-[100vh] -rotate-90 w-[100vh] px-4 flex flex-row md:font-bold gap-8 whitespace-nowrap"
      >
        <a href="/about">About</a>
        <a href="https://www.instagram.com/studio_ferregan/">Instagram</a>
        <a href="mailto:gustavo@ferregan.com">gustavo@ferregan.com</a>
        <a href="tel:00436705513222">+43 670 551 3222</a>
      </div>
    </nav>
  </footer>
</BaseLayout>
<script>
  const mobileMenu = document.getElementById("mobile-menu");
  const footer = document.getElementsByTagName("footer")[0];

  function openMobileMenu() {
    mobileMenu?.classList.add("left-0");
    mobileMenu?.classList.remove("left-full");
    // make content behind fixed overlay non-scrollable
    document.body.classList.add("overflow-hidden");
    footer?.classList.add("invisible");
  }
  function closeMobileMenu() {
    mobileMenu?.classList.remove("left-0");
    mobileMenu?.classList.add("left-full");
    document.body.classList.remove("overflow-hidden");
    footer?.classList.remove("invisible");
  }

  document
    .getElementById("mobile-menu-open")
    ?.addEventListener("click", openMobileMenu);
  document
    .getElementById("mobile-menu-close")
    ?.addEventListener("click", closeMobileMenu);

  document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
    const headingId = anchor.getAttribute("href");

    // highlight current section
    const observer = new IntersectionObserver((e) => {
      for (const intersectionEvent of e) {
        if (intersectionEvent.isIntersecting) {
          anchor.classList.add("md:font-bold");
        } else {
          anchor.classList.remove("md:font-bold");
        }
      }
    });

    const linkedSection = document.querySelector(
      `article[data-section="${headingId?.substring(1)}"]`
    );

    if (linkedSection) {
      observer.observe(linkedSection);
    }

    // smooth scrolling on navigation click
    anchor.addEventListener("click", (e) => {
      e.preventDefault();

      closeMobileMenu();
      // window.history.replaceState(null, "", headingId);

      document.querySelector(`${headingId}`)?.scrollIntoView({
        behavior: "smooth",
        block: "center",
      });
    });
  });
</script>
